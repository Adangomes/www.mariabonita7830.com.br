<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KINGS BURGER - Admin</title>
    <link rel="stylesheet" href="admin.css">
</head>
<body>
<!-- üîê LOGIN ADMIN -->
<div id="login-admin" style="
    position:fixed;
    inset:0;
    background:#000;
    z-index:30000;
    display:flex;
    align-items:center;
    justify-content:center;
">
    <div style="background:#111; padding:40px; border-radius:20px; text-align:center; width:320px;">
        <h2 style="color:#ffcc00;">KINGS BURGER</h2>
        <input type="password" id="senhaAdmin" placeholder="Digite a senha" style="width:100%; padding:15px; font-size:18px; border-radius:10px; border:none; margin:20px 0;">
        <button onclick="verificarSenha()" style="
            width:100%;
            padding:15px;
            font-size:18px;
            background:#ffcc00;
            border:none;
            border-radius:10px;
            font-weight:bold;
            cursor:pointer;
        ">ENTRAR</button>
        <p id="erro-senha" style="color:red; display:none;">Senha incorreta</p>
    </div>
</div>

<!-- üîä ATIVAR SOM -->
<div id="container-ativacao" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:10000; display:flex; align-items:center; justify-content:center;">
    <button onclick="ativarSomEDestravar()" style="padding:30px 60px; font-size:24px; background:#ffcc00; color:#000; border:none; border-radius:15px; font-weight:bold; cursor:pointer;">
        ATIVAR SOM DO SISTEMA
    </button>
</div>

<header class="admin-header">
    <h1>KINGS <span>BURGER</span></h1>
    <button class="btn-relatorio" onclick="abrirRelatorio()">HIST√ìRICO</button>
</header>

<ul id="pedidos-container"></ul>

<!-- MODAL RELAT√ìRIO -->
<div id="modal-relatorio" class="modal">
    <div class="modal-content">
        <span style="float:right; cursor:pointer; font-size:28px; color:white;" onclick="fecharRelatorio()">&times;</span>
        <h2 style="text-align:center; color:var(--primary);">HIST√ìRICO DE VENDAS</h2>
        <div class="stats-container">
            <div class="stat-box">PEDIDOS<br><b id="rel-qtd">0</b></div>
            <div class="stat-box">TOTAL VENDIDO<br><b id="rel-total">R$ 0,00</b></div>
        </div>
        <div class="table-wrapper">
            <table class="table-rel">
                <thead><tr><th>Hora</th><th>Cliente</th><th>Valor</th></tr></thead>
                <tbody id="tabela-relatorio"></tbody>
            </table>
        </div>
        <button class="btn-limpar" onclick="limparRelatorio()">LIMPAR HIST√ìRICO</button>
    </div>
</div>

<iframe id="iframe-impressao"></iframe>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
    // ===============================
    // üîê CONFIG SENHA ADMIN
    // ===============================
    const SENHA_ADMIN = "kings2026";

    function verificarSenha() {
        const senha = document.getElementById("senhaAdmin").value;
        if (senha === SENHA_ADMIN) {
            document.getElementById("login-admin").style.display = "none";
            localStorage.setItem("admin_logado", "true");
        } else {
            document.getElementById("erro-senha").style.display = "block";
        }
    }

    if (localStorage.getItem("admin_logado") === "true") {
        document.getElementById("login-admin").style.display = "none";
    }

    // ===============================
    // üîπ FIREBASE
    // ===============================
    const firebaseConfig = {
        apiKey: "AIzaSyCXA1yP1F-riNkzOX5zJs5gsQ82EzsT7Qg",
        authDomain: "myproject26-10f0e.firebaseapp.com",
        databaseURL: "https://myproject26-10f0e-default-rtdb.firebaseio.com",
        projectId: "myproject26-10f0e",
        storageBucket: "myproject26-10f0e.firebasestorage.app",
        messagingSenderId: "884850608032",
        appId: "1:884850608032:web:79db6983346c3c20edc6c5"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let prontoParaTocar = false;

    function ativarSomEDestravar() {
        const context = new(window.AudioContext || window.webkitAudioContext)();
        if (context.state === 'suspended') context.resume();
        new Audio('alert.mpeg').play().then(() => {
            prontoParaTocar = true;
            document.getElementById('container-ativacao').style.display = 'none';
        }).catch(() => alert("Arquivo alert.mpeg n√£o encontrado!"));
    }

    // ===============================
    // üîî LISTENER PEDIDOS NOVOS
    // ===============================
    db.ref('kings/pedidos').on('child_added', snap => {
        const pedido = snap.val();
        const id = snap.key;

        if (document.getElementById('card-' + id)) return; // evita duplicar cards

        // Usa transaction para definir numeroPedido de forma segura
        if (!pedido.numeroPedido) {
            db.ref('kings/contadorPedidos').transaction(current => {
                return (current || 0) + 1;
            }).then(result => {
                const numeroPedido = result.snapshot.val().toString().padStart(2, '0');
                db.ref('kings/pedidos/' + id).update({ numeroPedido });
                adicionarPedidoCard({ ...pedido, numeroPedido }, id);
            });
        } else {
            adicionarPedidoCard(pedido, id);
        }
    });

    // ===============================
    // üîπ FUN√á√ÉO ADICIONAR CARD
    // ===============================
    function adicionarPedidoCard(p, id){
        const numeroPedido = p.numeroPedido || '00';

        const li = document.createElement('li');
        li.className = 'pedido-card';
        li.id = `card-${id}`;

        let itensHtml = Array.isArray(p.itens) 
            ? p.itens.map(i => `‚Ä¢ ${i.qtd}x ${i.produto} <small style="color:#888;">(R$ ${parseFloat(i.precoUn || 0).toFixed(2)})</small>`).join('<br>')
            : "Erro";

        li.innerHTML = `
            <h3>Pedido: ${numeroPedido} - ${p.cliente} <span class="badge-pagamento">${p.pagamento}</span></h3>
            <div class="info"><b> Hor√°rio:</b> ${p.horario}</div>
            <div class="info"><b> Endere√ßo:</b> ${p.endereco}</div>
            <div class="info"><b> Ref:</b> ${p.referencia || 'N√£o informada'}</div>
            <div class="itens-box"><b style="color:var(--primary);"> ITENS DO PEDIDO:</b><br><div style="margin-top:5px;">${itensHtml}</div></div>
            <div class="info-obs">OBS: ${p.obs_cozinha || 'Nenhuma'}</div>
            <div class="financeiro-box">
                <div style="display:flex; justify-content:space-between; font-size:13px;">
                    <span>Produtos: R$ ${parseFloat(p.subtotal).toFixed(2)}</span>
                    <span>Taxa: R$ ${parseFloat(p.taxaEntrega).toFixed(2)}</span>
                </div>
                <div class="total">TOTAL: R$ ${parseFloat(p.total).toFixed(2)}</div>
            </div>
            <div class="btn-group">
                <button class="btn-cozinha" onclick="imprimir('cozinha', '${id}')">COZINHA</button>
                <button class="btn-motoboy" onclick="imprimir('motoboy', '${id}')">MOTOBOY</button>
            </div>
            <button class="btn-concluir" onclick="concluirPedido('${id}')">CONCLUIR PEDIDO</button>
        `;

        document.getElementById('pedidos-container').prepend(li);
        if (prontoParaTocar) new Audio('alert.mpeg').play().catch(()=>{});
    }

    // ===============================
    // üîπ IMPRIMIR COM N√öMERO DO PEDIDO
    // ===============================
    function imprimir(tipo, id) {
        db.ref('kings/pedidos/' + id).once('value', s => {
            const p = s.val();
            const numeroPedido = p.numeroPedido || '00';
            let lista = Array.isArray(p.itens) ? p.itens.map(i => `${i.qtd}x ${i.produto}`).join('<br>') : "";

            let html = (tipo==='cozinha') 
                ? `<div style="width:72mm;font-family:Arial;text-align:center;">
                        <h2>KINGS BURGER</h2>
                        <h3>Pedido: ${numeroPedido} - COZINHA (${p.horario})</h3><hr>
                        <div style="text-align:left;">
                            <b>CLIENTE:</b> ${p.cliente}<br>
                            <b>ITENS:</b><br>
                            <div style="font-size:18px;font-weight:bold;">${lista}</div><hr>
                            <b>OBS:</b> ${p.obs_cozinha || 'Nenhuma'}
                        </div>
                    </div>`
                : `<div style="width:72mm;font-family:Arial;font-size:14px;">
                        <center><h2>KINGS BURGER</h2>
                        <b>Pedido: ${numeroPedido}</b><br>
                        <b>HOR√ÅRIO: ${p.horario}</b></center><hr>
                        <b>CLIENTE:</b> ${p.cliente}<br>
                        <b>ENDERE√áO:</b> ${p.endereco}<br>
                        <b>REF:</b> ${p.referencia || 'N√£o informado'}<br>
                        <b>PAGAMENTO:</b> ${p.pagamento}<br><hr>
                        <b>PRODUTOS:</b><br>
                        <div style="font-size:16px;font-weight:bold;">${lista}</div><br>
                        Produtos: R$ ${parseFloat(p.subtotal || 0).toFixed(2)}<br>
                        Taxa: R$ ${parseFloat(p.taxaEntrega || 0).toFixed(2)}<br>
                        <b style="font-size:18px;">TOTAL: R$ ${parseFloat(p.total).toFixed(2)}</b><hr>
                        <b>OBS:</b> ${p.obs_cozinha || 'Nenhuma'}
                    </div>`;

            const win = document.getElementById('iframe-impressao').contentWindow;
            win.document.open();
            win.document.write(`<html><body style="margin:0;" onload="window.print()">${html}</body></html>`);
            win.document.close();
        });
    }

    // ===============================
    // ‚úÖ CONCLUIR PEDIDO
    // ===============================
    function concluirPedido(id) {
        if(confirm("Deseja concluir este pedido?")){
            const ref = db.ref('kings/pedidos/' + id);
            ref.once('value', s => {
                const pedido = s.val();
                db.ref('kings/relatorios').child(id).set(pedido).then(() => {
                    ref.remove().then(() => {
                        const card = document.getElementById('card-' + id);
                        if(card) card.remove();
                    });
                });
            });
        }
    }

    // ===============================
    // üìä RELAT√ìRIO
    // ===============================
    function abrirRelatorio() {
        const t = document.getElementById('tabela-relatorio'); t.innerHTML = '';
        let soma = 0; let q = 0;
        db.ref('kings/relatorios').once('value', s => {
            s.forEach(c => {
                const r = c.val(); soma += parseFloat(r.total); q++;
                t.innerHTML += `<tr><td>${r.horario}</td><td>${r.cliente}</td><td>R$ ${parseFloat(r.total).toFixed(2)}</td></tr>`;
            });
            document.getElementById('rel-total').innerText = 'R$ ' + soma.toFixed(2);
            document.getElementById('rel-qtd').innerText = q;
            document.getElementById('modal-relatorio').style.display = 'block';
        });
    }

    function fecharRelatorio() { document.getElementById('modal-relatorio').style.display = 'none'; }

    function limparRelatorio() { 
        if(confirm("Limpar todo o hist√≥rico?")){
            db.ref('kings/relatorios').remove();
            db.ref('kings/contadorPedidos').set(0); // Zera o contador de forma segura
            abrirRelatorio(); 
        }
    }

</script>
</body>
</html>
